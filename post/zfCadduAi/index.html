<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RWMutexçš„å®ç°åŸç† | é£é£çš„Blog</title>
<link rel="shortcut icon" href="https://ruofei-hu.github.io/favicon.ico?v=1684694787815">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://ruofei-hu.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="RWMutexçš„å®ç°åŸç† | é£é£çš„Blog - Atom Feed" href="https://ruofei-hu.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="
å¦‚æœå‡ºç°æ’ç‰ˆé”™ä¹±å¯ä»¥ç‚¹å‡»æˆ‘çš„Notioné“¾æ¥ğŸ”—

1.æ¦‚è¿°

åœ¨åŒæ­¥åŸè¯­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Mutexä¿æŠ¤ä¸´ç•ŒåŒºçš„èµ„æºå®‰å…¨ï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½å…è®¸ä¸€ä¸ªgoroutineè®¿é—®ä¸´ç•ŒåŒºçš„èµ„æºã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ç›¸å¯¹æµªè´¹èµ„æºã€‚æ¯”å¦‚åœ¨è¯»å¤šå†™å°‘çš„æƒ…å†µä¸‹ã€‚åœ¨ä¸€..." />
    <meta name="keywords" content="RWMutex,go,sync" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://ruofei-hu.github.io">
  <img class="avatar" src="https://ruofei-hu.github.io/images/avatar.png?v=1684694787815" alt="">
  </a>
  <h1 class="site-title">
    é£é£çš„Blog
  </h1>
  <p class="site-description">
    æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œå¯ä»¥è¿›æ­¥çŸ£ã€‚
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              RWMutexçš„å®ç°åŸç†
            </h2>
            <div class="post-info">
              <span>
                2023-05-19
              </span>
              <span>
                12 min read
              </span>
              
                <a href="https://ruofei-hu.github.io/tag/RufJEkYEp/" class="post-tag">
                  # RWMutex
                </a>
              
                <a href="https://ruofei-hu.github.io/tag/ohj_y06Gy/" class="post-tag">
                  # go
                </a>
              
                <a href="https://ruofei-hu.github.io/tag/pxq5pAh5Qy/" class="post-tag">
                  # sync
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <blockquote>
<p>å¦‚æœå‡ºç°æ’ç‰ˆé”™ä¹±å¯ä»¥ç‚¹å‡»<a href="https://ruofei-hu.notion.site/RWMutex-134cf4d5c2984e3682e27a77f435263c">æˆ‘çš„Notioné“¾æ¥ğŸ”—</a></p>
</blockquote>
<h1 id="1æ¦‚è¿°">1.æ¦‚è¿°</h1>
<ol>
<li>åœ¨åŒæ­¥åŸè¯­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Mutexä¿æŠ¤ä¸´ç•ŒåŒºçš„èµ„æºå®‰å…¨ï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½å…è®¸ä¸€ä¸ªgoroutineè®¿é—®ä¸´ç•ŒåŒºçš„èµ„æºã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ç›¸å¯¹æµªè´¹èµ„æºã€‚æ¯”å¦‚åœ¨<strong>è¯»å¤šå†™å°‘</strong>çš„æƒ…å†µä¸‹ã€‚åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰å†™çš„è¡Œä¸ºï¼Œä½†æ˜¯å­˜åœ¨å¤§é‡è¯»è¡Œä¸ºï¼Œä½†æ˜¯å› ä¸ºåœ¨Mutexçš„ä¿æŠ¤ä¸‹å¯ä»¥å¹¶å‘çš„è¯»æ“ä½œä¹Ÿæˆä¸ºäº†ä¸²è¡Œçš„è¯»æ“ä½œï¼Œå¯¹æ€§èƒ½çš„å½±å“å°±æ¯”è¾ƒå¤§ã€‚</li>
<li>æˆ‘ä»¬éœ€è¦åŒºåˆ†è¯»å†™æ“ä½œï¼Œä»¥ä¾¿äºæå‡æ€§èƒ½ã€‚å½“æŸä¸ªè¯»æ“ä½œgoroutineæŒæœ‰äº†é”ğŸ”ï¼Œå…¶ä»–è¯»æ“ä½œä¹Ÿå¯ä»¥æ‹¥æœ‰é”ğŸ”ï¼Œä¸€èµ·å¹¶å‘çš„è¿›è¡Œè¯»æ“ä½œï¼›å½“æŸäº›å†™æ“ä½œgoroutineæŒæœ‰äº†é”ğŸ”ï¼Œè¿™ä¸ªé”ğŸ”å°±æ˜¯ä¸ªç‹¬å é”ğŸ”ï¼Œæˆ–è€…è¯´æ˜¯æ’ä»–é”ğŸ”ï¼Œå…¶ä»–çš„è¯»æ“ä½œå’Œå†™æ“ä½œå¿…é¡»ç­‰å¾…å½“å‰çš„goroutineé‡Šæ”¾å½“å‰é”ä¹‹åæ‰å¯ä»¥ç»§ç»­ã€‚</li>
<li>ä¸Šè¿°çš„åŒæ—¶å­˜åœ¨å¤šä¸ªè¯»æ“ä½œå’Œå†™æ“ä½œï¼Œä½†æ˜¯åªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå†™æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹æ— è®ºè¯»å†™éƒ½æ— æ³•æ‰§è¡Œçš„çš„é—®é¢˜ç§°ä¸º<a href="https://en.wikipedia.org/wiki/Readers%E2%80%93writers_problem">readers&amp;writers</a>é—®é¢˜ã€‚åœ¨Goçš„Syncçš„åº“ä¸­å­˜åœ¨RWMutexçš„å¯ä»¥ç”¨æ¥è§£å†³æ­¤ç±»é—®é¢˜ã€‚</li>
</ol>
<h1 id="2ä½•ä¸ºrwmutex">2.ä½•ä¸ºRWMutexï¼Ÿ</h1>
<ol>
<li>RWMutexæ˜¯ä¸€ä¸ªè¯»å†™äº’æ–¥é”ğŸ”ã€‚RWMutexåœ¨åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½è¢«ä¸€ä¸ªwriteræŒæœ‰æˆ–è€…è¢«å¤šä¸ªreaderæŒæœ‰ã€‚</li>
<li>RWMutexçš„æ–¹æ³•é›†å…±5ä¸ªã€‚ï¼ˆpsï¼šåœ¨go1.20ç‰ˆæœ¬ç›®å‰æ–¹æ³•é›†ä¸º8ä¸ªï¼‰
<ol>
<li><strong>Lock\Unlockï¼šå†™æ“ä½œæ—¶ä½¿ç”¨çš„æ–¹æ³•</strong>ã€‚å¦‚æœå½“å‰çš„é”å·²è¢«readeræˆ–è€…writeræŒæœ‰ï¼Œé‚£ä¹ˆLockä¼šä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ã€‚Unlockæ˜¯Lockçš„é…å¯¹çš„é‡Šæ”¾é”çš„æ–¹æ³•ã€‚</li>
<li><strong>RLock\RUnLockï¼šè¯»æ“ä½œæ—¶ä½¿ç”¨çš„æ–¹æ³•</strong>ã€‚å¦‚æœé”å·²ç»è¢«writeræŒæœ‰äº†ï¼ŒRLockæ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ğŸ”ï¼Œå¦åˆ™å°±è¿”å›ï¼›RUnLockæ˜¯RLocké”é…å¯¹ä½¿ç”¨çš„é‡Šæ”¾é”çš„æ–¹æ³•</li>
<li><strong>RLockerï¼šæ­¤æ–¹æ³•ä¸ºè¯»æ“ä½œè¿”å›ä¸€ä¸ªLockeræ¥å£çš„å¯¹è±¡</strong>ã€‚è¿™ä¸ªå¯¹è±¡çš„Lockæ–¹æ³•ä¼šè°ƒç”¨RWMutexçš„RLockæ–¹æ³•ï¼ŒUnLockæ–¹æ³•ä¹Ÿæ˜¯ä¼šè°ƒç”¨RWMutexçš„RUnLockæ–¹æ³•ã€‚</li>
</ol>
</li>
<li>RWMutexçš„é›¶å€¼æ˜¯æœªåŠ é”çš„çŠ¶æ€ï¼Œå½“ä½ ä½¿ç”¨RWMutexçš„æ—¶å€™ï¼Œæ— éœ€æ˜¾ç¤ºçš„åˆå§‹åŒ–ã€‚
<ol>
<li>
<p>ä¸¾ä¸ªæ —å­ğŸŒ°ï¼šè®¡æ•°å™¨ï¼Œcount++ æ˜¯å†™æ“ä½œï¼Œè·å–Countçš„å€¼æ˜¯è¯»æ“ä½œï¼Œè¯»æ“ä½œå¯ä»¥å¹¶å‘è¯»å–ï¼Œå†™æ“ä½œåªèƒ½ç‹¬å æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨RWMutexæ¥è§£å†³è¿™ä¸ªreaders-writersé—®é¢˜ã€‚</p>
<pre><code>package main

import (
	&quot;sync&quot;
	&quot;time&quot;
)

// Counter å®šä¹‰è®¡æ•°å™¨
type Counter struct {
	rwm   sync.RWMutex
	count uint64
}

// Incr å†™é”ä¿æŠ¤
func (c *Counter) Incr() {
	c.rwm.Lock()
	defer c.rwm.Unlock()
	c.count++

}

// GetCount è¯»é”ä¿æŠ¤
func (c *Counter) GetCount() uint64 {
	c.rwm.RLock()
	defer c.rwm.RUnlock()
	return c.count
}

func main() {
	var counter Counter
	for i := 0; i &lt; 10; i++ {
		go func() {
			for {
				counter.GetCount()
				time.Sleep(time.Millisecond)// æ¯æ¯«ç§’çš„ç«äº‰
			}
		}()
	}

	for {
		counter.Incr()
		time.Sleep(time.Second)// æ¯ç§’ç«äº‰
	}
}
</code></pre>
<p>é‡åˆ°æ˜ç¡®å¯ä»¥åŒºåˆ†readerå’Œwriterçš„åœºæ™¯ï¼Œå¹¶ä¸”å­˜åœ¨å¤§é‡è¯»ï¼Œå°‘é‡å†™å’Œæœ‰æ€§èƒ½è¦æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨RWMutexæ›¿æ¢Mutexã€‚</p>
</li>
</ol>
</li>
</ol>
<h1 id="3rwmutexçš„å®ç°åŸç†">3.RWMutexçš„å®ç°åŸç†</h1>
<ol>
<li>
<p>RWMutexæ˜¯éå¸¸çš„åŸºæœ¬å¹¶å‘åŸè¯­ã€‚Goä¸­RWMutexæ˜¯åŸºäºMutexå®ç°çš„ã€‚å‰é¢æˆ‘ä»¬æåˆ°RWMutexæ˜¯è§£å†³readers-writersåœºæ™¯çš„åˆ©å™¨ï¼Œä½†æ˜¯readers-writersä¹Ÿåˆ†å¥½å‡ ç§ï¼š</p>
<ul>
<li>Read-Preferringï¼šè¯»æ“ä½œä¼˜å…ˆï¼Œå¯ä»¥æä¾›å¾ˆé«˜çš„å¹¶å‘æ€§ã€‚ä½†æ˜¯åœ¨è¯»é”ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹å¯èƒ½å¯¼è‡´å†™é¥¥é¥¿ã€‚å› ä¸ºæœ‰å¤§é‡çš„è¯»æ“ä½œï¼Œå¯¼è‡´å†™æ“ä½œåªèƒ½åœ¨æ‰€æœ‰è¯»æ“ä½œé‡Šæ”¾é”ğŸ”ä¹‹åæ‰èƒ½æ‰§è¡Œ</li>
<li>Write-Preferringï¼šå†™æ“ä½œä¼˜å…ˆï¼Œå¦‚æœå½“å‰é”çš„waitlistå­˜åœ¨ä¸€ä¸ªå†™æ“ä½œç­‰åˆ°ï¼Œé‚£ä¹ˆåç»­çš„readerå°†ä¼šè¢«é˜»æ­¢è·å–åˆ°é”ï¼Œä¼˜å…ˆwriterè·å–é”ğŸ”ã€‚å¦‚æœä¹‹å‰çš„readerå·²ç»è·å–åˆ°é”ğŸ”ï¼Œé‚£ä¹ˆwriteré¡µåªèƒ½ç­‰å¾…readeré‡Šæ”¾é”ğŸ”ä¹‹åæ‰èƒ½è·å–é”ã€‚å†™æ“ä½œä¼˜å…ˆï¼Œåªæ˜¯çœŸå¤šåç»­çš„æ–°è¯·æ±‚è€Œè¨€ï¼Œè¿™ç§è®¾è®¡é¿å…å†™é¥¥é¥¿ã€‚</li>
<li>ä¸æŒ‡å®šä¼˜å…ˆçº§ï¼šä¸åŒºåˆ†å†™æ“ä½œå’Œè¯»æ“ä½œçš„ä¼˜å…ˆçº§</li>
</ul>
</li>
<li>
<p>Goä¸­çš„RWMutexçš„è®¾è®¡æ–¹æ¡ˆæ˜¯Writer-Preferringã€‚RWMutexä¸­åŒ…å«äº”ä¸ªå­—æ®µ</p>
<pre><code>type RWMutex struct {
	w           Mutex        // held if there are pending writers
	writerSem   uint32       // semaphore for writers to wait for completing readers
	readerSem   uint32       // semaphore for readers to wait for completing writers
	readerCount atomic.Int32 // number of pending readers
	readerWait  atomic.Int32 // number of departing readers
}

const rwmutexMaxReaders = 1 &lt;&lt; 30
</code></pre>
<ul>
<li>w: ä¸ºäº†è§£å†³Writerç«äº‰é”è€Œè®¾è®¡</li>
<li>writerSemå’ŒreaderSemï¼šä¸ºäº†é˜»å¡è®¾è®¡çš„ä¿¡å·é‡</li>
<li>readerCountï¼šå½“å‰å¾…å¤„ç†çš„readerçš„æ•°é‡ä»¥åŠæ˜¯å¦å­˜åœ¨Writerç­‰å¾…é”ğŸ”</li>
<li>readerWaitï¼šè®°å½•Writeråœ¨èƒ½è·å–åˆ°é”ä¹‹å‰è¿˜å‰©ä½™çš„readerçš„æ•°é‡</li>
<li>rwmutexMaxReadersï¼šå®šä¹‰äº†readerçš„æœ€å¤§æ•°é‡</li>
</ul>
</li>
<li>
<p>RLockå’ŒRUnLockçš„å®ç°</p>
<pre><code> 1. func (rw *RWMutex) RLock() {
 2.     if race.Enabled {
 3.         _ = rw.w.state
 4.         race.Disable()
 5.     }
 6.
 7.     if rw.readerCount.Add(1) &lt; 0 {
 8.         // A writer is pending, wait for it.
 9.         // å½“readerCountä¸ºè´Ÿå€¼è¡¨ç¤ºå­˜åœ¨Writerç­‰å¾…é”ï¼Œå› ä¸ºæ˜¯å†™æ“ä½œä¼˜å…ˆï¼Œæ‰€ä»¥åç»­æ–°æ¥readeréœ€è¦é€šè¿‡readerSemä¿¡å·é‡é˜»å¡ä¼‘çœ 
10.         runtime_SemacquireRWMutexR(&amp;rw.readerSem, false, 0)
11.     }
12.
13.     if race.Enabled {
14.         race.Enable()
15.         race.Acquire(unsafe.Pointer(&amp;rw.readerSem))
16.     }
17. }
18.
19. func (rw *RWMutex) RUnlock() {
20.     if race.Enabled {
21.         _ = rw.w.state
22.         race.ReleaseMerge(unsafe.Pointer(&amp;rw.writerSem))
23.         race.Disable()
24.     }
25.     if r := rw.readerCount.Add(-1); r &lt; 0 {
26.         // Outlined slow-path to allow the fast-path to be inlined
27.         rw.rUnlockSlow(r)
28.     }
29.     if race.Enabled {
30.         race.Enable()
31.     }
32. }
33.
34. func (rw *RWMutex) rUnlockSlow(r int32) {
35.     if r+1 == 0 || r+1 == -rwmutexMaxReaders {
36.         race.Enable()
37.         fatal(&quot;sync: RUnlock of unlocked RWMutex&quot;)
38.     }
39.     // A writer is pending.
40.     if rw.readerWait.Add(-1) == 0 {
41.         // The last reader unblocks the writer.
42.         runtime_Semrelease(&amp;rw.writerSem, false, 1)
43.     }
44. }

</code></pre>
<p>ç¬¬7è¡Œæ˜¯å¯¹readerè¿›è¡ŒåŠ ä¸€æ“ä½œã€‚readerCountæœ‰åŒé‡å«ä¹‰ï¼š</p>
<ul>
<li>å½“æ²¡æœ‰Writerç­‰å¾…é”æˆ–è€…æŒæœ‰é”æ—¶ï¼ŒreaderCountå°±æ˜¯ä¸€ä¸ªå•çº¯çš„readerè®¡æ•°å™¨ï¼›</li>
<li>å½“Writerç­‰å¾…é”æˆ–è€…æŒæœ‰é”ğŸ”æ—¶ï¼ŒreaderCountä¸ä»…ä»…è¡¨ç¤ºreaderçš„æ•°é‡ï¼Œè¿˜å¯ä»¥è¡¨ç¤ºå½“å‰æ˜¯å¦æœ‰Writerç­‰å¾…é”æˆ–è€…æŒæœ‰é”ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™åç»­çš„æ–°è¯·æ±‚çš„readerså°±ä¼šå¦‚ç¬¬åè¡Œï¼Œè¿›å…¥åˆ°é˜»å¡çŠ¶æ€ï¼Œæ¯•ç«Ÿæ˜¯Writer-Preferringã€‚</li>
</ul>
<p>å½“è°ƒç”¨RUnLockçš„æ—¶å€™ï¼Œreaderçš„æ•°é‡å‡å°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†readerçš„è®¡æ•°è¿›è¡Œå‡ä¸€æ“ä½œã€‚ä½†æ˜¯ç¬¬25è¡Œçš„Addçš„è¿”å›å€¼å¦‚æœæ˜¯è´Ÿå€¼çš„æƒ…å†µä¸‹ï¼Œé‚£å°±ä»£è¡¨å½“å‰æœ‰Writerç«äº‰é”ï¼Œåœ¨æœ‰Writerç«äº‰é”çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šè°ƒç”¨rUnlockSlowæ–¹æ³•ï¼Œå…ˆæ£€æŸ¥readeræ˜¯éƒ½å…¨éƒ¨éƒ½é‡Šæ”¾é”ï¼Œå¦‚æœå…¨éƒ¨é‡Šæ”¾é”äº†ï¼Œé‚£ä¹ˆå°±å”¤é†’ç­‰å¾…é”çš„Writerã€‚</p>
<p>å½“ä¸€ä¸ªreaderæˆ–è€…å¤šä¸ªreaderæŒæœ‰é”ğŸ”æ—¶ï¼Œè¯·æ±‚é”çš„Writerä¼šç­‰å¾…è¿™äº›readerå…¨éƒ¨é‡Šæ”¾é”åï¼Œæ‰å¯ä»¥å»æŒæœ‰è¿™æŠŠé”ğŸ”ã€‚Writer-preferringåªæ˜¯è§„å®šåœ¨Writerä¹‹ååˆ°æ¥readerä¸å¯ä»¥å’ŒWriterç«äº‰é”ï¼Œå¯¹æ—¢æœ‰çš„readerçš„ç°çŠ¶æ˜¯æ²¡æœ‰æƒé™æ”¹å˜çš„ã€‚rUnlockSlowå°†æŒæœ‰é”çš„readeræ•°é‡å‡ä¸€ï¼Œç„¶åæ£€æŸ¥åœ¨Writerä¹‹å‰çš„readeræ˜¯å¦å…¨éƒ¨é‡Šæ”¾äº†é”ğŸ”ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå°†ä¼šå”¤é†’Writerï¼Œè®©WriteræŒæœ‰é”ğŸ”ã€‚</p>
</li>
<li>
<p>Lockçš„å®ç°</p>
<ol>
<li>RWMutexæ˜¯è§£å†³readers-writersé—®é¢˜çš„ï¼Œæ‰€ä»¥ä¼šåŒæ—¶å­˜åœ¨å¤šä¸ªreaderå’Œå¤šä¸ªWriterç«äº‰é”ã€‚ä½†æ˜¯readerä¹‹é—´å¯ä»¥å¹¶å‘çš„æ‰§è¡Œï¼Œä½†æ˜¯Writerä¹‹é—´ä¸è¡Œï¼ŒWriterä¹‹é—´æ˜¯å…·æœ‰æ’ä»–æ€§çš„ã€‚æ‰€æœ‰RWMutexç»“æ„ä½“ä¸­çš„ç¬¬ä¸€ä¸ªå­—æ®µMutexå°±æ˜¯ä¸ºäº†è§£å†³Writerä¹‹é—´çš„ç«äº‰çš„.</li>
<li>ä¸€æ—¦å…¶ä¸­çš„ä¸€ä¸ªWriterè·å¾—ç»“æ„ä½“å†…éƒ¨çš„Mutexäº’æ–¥é”ï¼Œå°±ä¼šè®²åŸæœ¬çš„readerCountè¿›è¡Œåè½¬ï¼Œå°†readerCountä»æ•´æ•°å˜ä¸ºï¼ˆreaderCount-rwmutexMaxReadersï¼‰ï¼Œä½¿readerCountæ—¢ä¿å­˜äº†readerCountçš„æ•°é‡ä¹Ÿæ ‡è¯†äº†å½“å‰å­˜åœ¨Writerç«äº‰é”ğŸ”</li>
<li></li>
</ol>
<pre><code>func (rw *RWMutex) Lock() {
	if race.Enabled {
		_ = rw.w.state
		race.Disable()
	}

	// First, resolve competition with other writers. ä½¿ç”¨wäº’æ–¥é”å…ˆè§£å†³Writerä¹‹é—´çš„ç«äº‰
	rw.w.Lock()
	// Announce to readers there is a pending writer. åè½¬readerCountï¼ŒåŒæ—¶å‘readerå®£å‘Šæœ‰è¯·æ±‚é”çš„Writerå­˜åœ¨
	r := rw.readerCount.Add(-rwmutexMaxReaders) + rwmutexMaxReaders // æŒæœ‰é”ä½†è¿˜æœªé‡Šæ”¾çš„reader
	// Wait for active readers. å¦‚æœå½“å‰çš„é”åœ¨readeræ‰‹ä¸­æŒæœ‰ï¼Œé‚£ä¹ˆWriterè¿˜éœ€è¦è¿›è¡Œç­‰å¾…
	if r != 0 &amp;&amp; rw.readerWait.Add(r) != 0 { // å¦‚æœå½“å‰çš„readerCountä¸æ˜¯0ï¼Œå°±è¡¨æ˜å½“å‰å­˜åœ¨æ´»è·ƒçš„readerï¼Œå°±éœ€è¦æŠŠreaderCountèµ‹å€¼ç»™readerWaitä¿å­˜ä¸‹æ¥ï¼Œç„¶åWriterè¿›å…¥åˆ°é˜»å¡ç­‰å¾…çš„çŠ¶æ€ã€‚
		runtime_SemacquireRWMutex(&amp;rw.writerSem, false, 0)
	}

	if race.Enabled {
		race.Enable()
		race.Acquire(unsafe.Pointer(&amp;rw.readerSem))
		race.Acquire(unsafe.Pointer(&amp;rw.writerSem))
	}
}
</code></pre>
<p>å½“æ¯ä¸ªreaderè°ƒç”¨RUnlockçš„æ—¶å€™ï¼ŒreaderWaitçš„è®¡æ•°ä¼šå‡ä¸€ï¼Œç›´åˆ°å½“å‰æ´»è·ƒçš„readerï¼ˆåœ¨Writerä¹‹å‰çš„æ—¢æœ‰çš„readerï¼‰çš„æ•°é‡å‡è‡³ä¸ºé›¶ï¼Œå°†ä¼šå”¤é†’Writerã€‚</p>
</li>
<li>
<p>Unlockçš„å®ç°</p>
<ol>
<li>å½“Writeré‡Šæ”¾é”ğŸ”çš„æ—¶å€™ï¼Œä¼šå†æ¬¡å°†readerCountè¿™ä¸ªæ•°å€¼è¿›è¡Œç¿»è½¬ï¼Œå³é‡æ–°åŠ ä¸ŠrwmutexMaxReadersè¿™ä¸ªå€¼ã€‚Writeré‡Šæ”¾é”ğŸ”ä¹‹åï¼Œå°†ä¼šå”¤é†’åç»­ç«äº‰é”ğŸ”çš„readerï¼Œç»§ç»­æ‰§è¡Œä¸‹å»ã€‚å½“å‰çš„Writeréœ€è¦è¿›è¡ŒUnlockå°†ä¸´ç•ŒåŒºçš„æ‰€æœ‰æƒå½’è¿˜ï¼ˆä¹Ÿå°±æ˜¯éœ€è¦å°†é”ğŸ”é‡Šæ”¾ï¼‰ï¼Œä»¥ä¾¿äºå…¶ä»–çš„Writeråç»­å¯ä»¥è¿›è¡Œç«äº‰</li>
<li></li>
</ol>
<pre><code>func (rw *RWMutex) Unlock() {
	if race.Enabled {
		_ = rw.w.state
		race.Release(unsafe.Pointer(&amp;rw.readerSem))
		race.Disable()
	}

	// Announce to readers there is no active writer.
	// å‘ŠçŸ¥readerå½“å‰å·²æ— æ´»è·ƒçš„Writer
	r := rw.readerCount.Add(rwmutexMaxReaders)
	if r &gt;= rwmutexMaxReaders {
		race.Enable()
		fatal(&quot;sync: Unlock of unlocked RWMutex&quot;)
	}
	// Unblock blocked readers, if any.
	// å”¤é†’é˜»å¡çš„reader
	for i := 0; i &lt; int(r); i++ {
		runtime_Semrelease(&amp;rw.readerSem, false, 0)
	}
	// Allow other writers to proceed.
	// é‡Šæ”¾é”ï¼Œä½¿åç»­çš„Writerå¯ä»¥ç«äº‰é”
	rw.w.Unlock()

	if race.Enabled {
		race.Enable()
	}
}
</code></pre>
<p>c. RWMutexçš„æ³¨æ„äº‹é¡¹</p>
<ol>
<li>ä¸å¯å¤åˆ¶ã€‚å› ä¸ºé”ğŸ”éƒ½æ˜¯å…·æœ‰çŠ¶æ€çš„ï¼Œå¦‚æœå¤åˆ¶ä¸€ä¸ªé”ï¼Œä¼šè¿åŒå½“å‰é”ğŸ”å†…éƒ¨çš„çŠ¶æ€ä¹Ÿä¸€åŒå¤åˆ¶å»ã€‚</li>
<li>ä¸å¯é‡å…¥é”ğŸ”ã€‚è¯»å†™é”å› ä¸ºé‡å…¥é”ğŸ”æˆ–è€…é€’å½’è°ƒç”¨ä¼šå¯¼è‡´æ­»é”ğŸ”ã€‚
<ol>
<li>
<p>é‡å…¥å¯¼è‡´æ­»é”çš„é—®é¢˜ã€‚å› ä¸ºè¯»å†™é”æ˜¯åŸºäºäº’æ–¥é”å®ç°çš„ï¼Œå› ä¸ºäº’æ–¥é”é‡å…¥ä¼šå¯¼è‡´æ­»é”é—®é¢˜ï¼Œæ‰€ä»¥å½“Writeré‡å…¥Lockçš„æ—¶å€™ï¼Œä¹Ÿä¼šäº§ç”Ÿè¿™ä¸ªé—®é¢˜ã€‚</p>
<pre><code>func test1(mutex *sync.RWMutex) {
	mutex.Lock()
	defer mutex.Unlock()
	fmt.Println(&quot;this is test1&quot;)
}

func test2(mutex *sync.RWMutex) {
	fmt.Println(&quot;thist is test2&quot;)
	mutex.Lock()
	defer mutex.Unlock()
	test1(mutex)
}

func main() {
	rwMutex := &amp;sync.RWMutex{}
	test2(rwMutex)
}
</code></pre>
</li>
<li>
<p>è¿˜æœ‰ä¸€ç§å°±æ˜¯åœ¨è¯»æ“ä½œä¸­åµŒå…¥å†™æ“ä½œã€‚å‰é¢çš„æœ‰å†™åˆ°ï¼Œå½“å­˜åœ¨æ´»è·ƒçš„readerçš„æ—¶å€™ï¼ŒWriterå¿…é¡»ç­‰å¾…æ´»è·ƒçš„readerå…¨éƒ¨é‡Šæ”¾å®Œåï¼Œæ‰å¯ä»¥è¿›è¡ŒæŒæœ‰é”ï¼Œä½†æ˜¯å¦‚æœåœ¨readerä¸­åµŒå…¥Writerï¼Œreaderæƒ³ç­‰å¾…Writeræ‰§è¡Œå®Œæˆåæ‰é‡Šæ”¾é”ï¼Œä½†æ˜¯Writeréœ€è¦ç­‰å¾…æ´»è·ƒçš„readeré‡Šæ”¾é”åæ‰å¯ä»¥ç”¨æœ‰é”æ‰å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå°±å½¢æˆäº†äº’ç›¸ä¾èµ–ï¼Œå°±ä¼šé€ æˆæ­»é”çŠ¶æ€ã€‚</p>
</li>
<li>
<p>å†è€…å°±æ˜¯ä¸Šè¿°ç‰ˆæœ¬çš„åŠ å¼ºç‰ˆï¼Œå°±æ˜¯Writerä¾èµ–readerAï¼Œè¿™ä¸ªreaderAä¾èµ–readerBï¼Œä½†æ˜¯readerBä¸­åµŒå¥—ç€writerï¼Œç„¶åå½¢æˆç›¸äº’ä¾èµ–ï¼Œå°±ä¼šé€ æˆæ­»é”ç°è±¡ã€‚</p>
</li>
</ol>
</li>
<li>Unlockä½è§£é”çš„RWMutexï¼Œä¼šé€ æˆpanicã€‚Lockå’ŒUnlockï¼Œä»¥åŠRLockå’ŒRUnlockæˆå¯¹å‡ºç°å¯ä»¥é¿å…é—æ¼ï¼Œé¿å…é‡å¤Unlockeré€ æˆçš„panic</li>
</ol>
</li>
</ol>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>åœ¨æ—¥å¸¸çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°ä¸´ç•ŒåŒºèµ„æºéœ€è¦ä¿æŠ¤çš„æ—¶å€™ï¼Œä¼˜å…ˆè€ƒè™‘Mutexçš„ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸æ¸…æ¥šåç»­çš„è®¾è®¡å°†ä¼šå¦‚ä½•æ¼”å˜ï¼Œç­‰åˆ°åæœŸä¸šåŠ¡é€æ¸æˆç†Ÿï¼Œéœ€è¦åšè¿›ä¸€æ­¥çš„æ€§èƒ½æå‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¯»å†™é”è¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚ä½†æ˜¯å¦‚æœä½ ä¸€å¼€å§‹å°±ç›®çš„æ˜ç¡®ï¼Œæ¯”å¦‚ä½ çŸ¥é“é‡åˆ°çš„å°±æ˜¯æ˜ç¡®çš„readers-writersé—®é¢˜æˆ–è€…å¹¶å‘å®‰å…¨çš„mapå¯ä»¥ç›´æ¥é‡‡ç”¨è¯»å†™é”ã€‚å¹¶ä¸”åœ¨Syncä¸­æœ‰å¹¶å‘å®‰å…¨çš„sync.mapã€‚Enjoy itâ€¦..</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#1%E6%A6%82%E8%BF%B0">1.æ¦‚è¿°</a></li>
<li><a href="#2%E4%BD%95%E4%B8%BArwmutex">2.ä½•ä¸ºRWMutexï¼Ÿ</a></li>
<li><a href="#3rwmutex%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">3.RWMutexçš„å®ç°åŸç†</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://ruofei-hu.github.io/post/go-Mutex-evl/">
              <h3 class="post-title">
                Mutexæ¼”åŒ–å²
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://ruofei-hu.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
