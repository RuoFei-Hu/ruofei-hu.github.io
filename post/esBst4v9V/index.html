<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WaitGroup: ä»»åŠ¡ç¼–æ’åˆ©å™¨ | é£é£çš„Blog</title>
<link rel="shortcut icon" href="https://ruofei-hu.github.io/favicon.ico?v=1684694787815">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://ruofei-hu.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="WaitGroup: ä»»åŠ¡ç¼–æ’åˆ©å™¨ | é£é£çš„Blog - Atom Feed" href="https://ruofei-hu.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="
å¦‚æœå‡ºç°æ’ç‰ˆé”™ä¹±å¯ä»¥ç‚¹å‡»æˆ‘çš„Notioné“¾æ¥ğŸ”—

1.æ¦‚è¿°
WaitGroupæ˜¯Syncä¸­ç”¨ä½œä»»åŠ¡ç¼–æ’çš„å¹¶å‘åŸè¯­ã€‚ä¸»è¦è§£å†³çš„å°±æ˜¯å¹¶å‘-ç­‰å¾…çš„é—®é¢˜ï¼šå¦‚æœæœ‰ä¸€ä¸ªgoroutineAåœ¨checkpointç­‰å¾…ä¸€ç»„goroutineå®Œæˆä»»åŠ¡ï¼Œå¦‚..." />
    <meta name="keywords" content="WaitGroup,go,sync" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://ruofei-hu.github.io">
  <img class="avatar" src="https://ruofei-hu.github.io/images/avatar.png?v=1684694787815" alt="">
  </a>
  <h1 class="site-title">
    é£é£çš„Blog
  </h1>
  <p class="site-description">
    æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œå¯ä»¥è¿›æ­¥çŸ£ã€‚
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              WaitGroup: ä»»åŠ¡ç¼–æ’åˆ©å™¨
            </h2>
            <div class="post-info">
              <span>
                2023-05-22
              </span>
              <span>
                6 min read
              </span>
              
                <a href="https://ruofei-hu.github.io/tag/4xGERmKsX/" class="post-tag">
                  # WaitGroup
                </a>
              
                <a href="https://ruofei-hu.github.io/tag/ohj_y06Gy/" class="post-tag">
                  # go
                </a>
              
                <a href="https://ruofei-hu.github.io/tag/pxq5pAh5Qy/" class="post-tag">
                  # sync
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <blockquote>
<p>å¦‚æœå‡ºç°æ’ç‰ˆé”™ä¹±å¯ä»¥ç‚¹å‡»<a href="https://www.notion.so/ruofei-hu/WaitGroup-853962a4bf3949cc9f8fb5705baeea83?pvs=4">æˆ‘çš„Notioné“¾æ¥ğŸ”—</a></p>
</blockquote>
<h1 id="1æ¦‚è¿°">1.æ¦‚è¿°</h1>
<p>WaitGroupæ˜¯Syncä¸­ç”¨ä½œä»»åŠ¡ç¼–æ’çš„å¹¶å‘åŸè¯­ã€‚ä¸»è¦è§£å†³çš„å°±æ˜¯å¹¶å‘-ç­‰å¾…çš„é—®é¢˜ï¼šå¦‚æœæœ‰ä¸€ä¸ªgoroutineAåœ¨checkpointç­‰å¾…ä¸€ç»„goroutineå®Œæˆä»»åŠ¡ï¼Œå¦‚æœè¿™äº›goroutineçš„ä»»åŠ¡è¿˜æ²¡å…¨éƒ¨å®Œæˆï¼Œé‚£ä¹ˆgoroutineAå°±éœ€è¦åœ¨checkpointå¤„é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°è¿™ç»„goroutineå…¨éƒ¨å®Œæˆä»»åŠ¡ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p>
<h1 id="2waitgroupçš„åŸºæœ¬ç”¨æ³•">2.WaitGroupçš„åŸºæœ¬ç”¨æ³•</h1>
<ol>
<li>
<p>åœ¨Goçš„Syncä¸­WaitGroupæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<pre><code>func (wg *WaitGroup) Add(delta int)
func (wg *WaitGroup) Done()
func (wg *WaitGroup) Wait()
</code></pre>
<ul>
<li>Addï¼šç”¨æ¥æ“ä½œï¼ˆå¢åŠ æˆ–è€…å‡å°‘ï¼‰WaitGroupè®¡æ•°å™¨çš„æ•°å€¼</li>
<li>Doneï¼šç”¨æ¥å‡å°‘WaitGroupè®¡æ•°å™¨çš„æ•°å€¼ï¼Œå…¶å®å†…éƒ¨å°±æ˜¯è°ƒç”¨äº†Add(-1)ï¼Œæœ‰æ„æ€å§ğŸ¥³ï¼Œå“ˆå“ˆå“ˆ</li>
<li>Waitï¼šåœ¨WaitGroupè®¡æ•°å™¨çš„æ•°å€¼ä¸ä¸ºé›¶ä¹‹å‰ï¼Œè°ƒç”¨Waitçš„goroutineä¼šä¸€ç›´é˜»å¡</li>
</ul>
</li>
<li>
<p>è€è§„çŸ©ï¼Œä¸¾ä¸ªæ —å­ğŸŒ°ï¼š</p>
<pre><code>// Counter å¹¶å‘å®‰å…¨çš„è®¡æ•°å™¨
type Counter struct {
	mu    sync.Mutex
	count uint64
}

// Incr å¯¹è®¡æ•°å™¨åŠ ä¸€
func (c *Counter) Incr() {
	c.mu.Lock()
	defer c.mu.Unlock()
	c.count++
}

// GetCount è·å–è®¡æ•°å™¨çš„å€¼
func (c *Counter) GetCount() uint64 {
	c.mu.Lock()
	defer c.mu.Unlock()
	return c.count
}

// Worker æ‰“å·¥äºº
func Worker(c *Counter, wg *sync.WaitGroup) {
	defer wg.Done()
	c.Incr()
	time.Sleep(time.Second)
}

func main() {
	var counter Counter
	var wg sync.WaitGroup

	for i := 0; i &lt; 10; i++ {
		wg.Add(1)
		go Worker(&amp;counter, &amp;wg)
	}
	wg.Wait()
	fmt.Println(counter.GetCount())
}
</code></pre>
<p>æˆ‘ä»¬åœ¨mainå‡½æ•°ä¸­é€šè¿‡forå¾ªç¯ä½¿ç”¨Addä¸ºWaitGroupçš„è®¡æ•°å™¨æ·»åŠ äº†10ä¸ªä»»åŠ¡ï¼ŒåŒæ—¶ä¹Ÿç”Ÿæˆäº†10ä¸ªgoroutineåŒºæ‰§è¡Œå¯¹CounteråŠ ä¸€çš„ä»»åŠ¡ã€‚åœ¨workerä¸­ï¼Œæ¯å®Œæˆä¸€ä¸ªä»»åŠ¡å°±ä¼šè°ƒç”¨Doneå‡½æ•°è¿›è¡Œwgçš„è®¡æ•°å™¨è¿›è¡Œå‡ä¸€ã€‚å› ä¸ºæˆ‘ä»¬åœ¨mainå‡½æ•°ä¸­è°ƒç”¨äº†wg.Waitï¼Œæ‰€åœ¨åœ¨wgçš„è®¡æ•°å™¨å€¼å˜ä¸º0ä¹‹å‰ï¼Œç¨‹åºéƒ½ä¼šé˜»å¡åˆ°å½“å‰çš„ä½ç½®ï¼Œç›´åˆ°10ä¸ªgoroutineéƒ½å®Œæˆäº†å¯¹Countçš„åŠ ä¸€ä»»åŠ¡ï¼Œç¨‹åºæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œè¾“å…¥å½“å‰Countçš„å€¼ã€‚</p>
</li>
</ol>
<h1 id="3waitgroupçš„å®ç°">3.WaitGroupçš„å®ç°</h1>
<ol>
<li></li>
</ol>
<pre><code>type WaitGroup struct {
	noCopy noCopy

	state atomic.Uint64 // high 32 bits are counter, low 32 bits are waiter count.
	sema  uint32
}
</code></pre>
<ul>
<li>npCopyå­—æ®µï¼šä¸»è¦æ˜¯ä¸ºäº†å¤åˆ¶vetå·¥å…·æ£€æµ‹æ˜¯å¦æœ‰é€šè¿‡å¤åˆ¶WaitGroupè¿™ä¸ªå®ä¾‹çš„</li>
<li>stateå­—æ®µï¼šé«˜32ä½æ˜¯è®¡æ•°å™¨ï¼Œä½32ä½æ˜¯waiterçš„è®¡æ•°</li>
<li>semaå­—æ®µï¼šä¿¡å·é‡</li>
</ul>
<p>b. Addçš„å®ç°é€»è¾‘</p>
<pre><code>func (wg *WaitGroup) Add(delta int) {
.......
	state := wg.state.Add(uint64(delta) &lt;&lt; 32)// é«˜32ä½æ˜¯Count å°±æ˜¯V
	v := int32(state &gt;&gt; 32) // è®¡æ•°å™¨
	w := uint32(state) // waiter
	if race.Enabled &amp;&amp; delta &gt; 0 &amp;&amp; v == int32(delta) {
		// The first increment must be synchronized with Wait.
		// Need to model this as a read, because there can be
		// several concurrent wg.counter transitions from 0.
		race.Read(unsafe.Pointer(&amp;wg.sema))
	}
	if v &lt; 0 {
		panic(&quot;sync: negative WaitGroup counter&quot;)
	}
	if w != 0 &amp;&amp; delta &gt; 0 &amp;&amp; v == int32(delta) {
		panic(&quot;sync: WaitGroup misuse: Add called concurrently with Wait&quot;)
	}
	if v &gt; 0 || w == 0 {
		return
	}
	// This goroutine has set counter to 0 when waiters &gt; 0.
	// Now there can't be concurrent mutations of state:
	// - Adds must not happen concurrently with Wait,
	// - Wait does not increment waiters if it sees counter == 0.
	// Still do a cheap sanity check to detect WaitGroup misuse.
	if wg.state.Load() != state {
		panic(&quot;sync: WaitGroup misuse: Add called concurrently with Wait&quot;)
	}
	// Reset waiters count to 0.
	wg.state.Store(0)
	for ; w != 0; w-- {
		runtime_Semrelease(&amp;wg.sema, false, 0)
	}
}
</code></pre>
<p>Addå®ç°ï¼šä¸»è¦é€šè¿‡å†…éƒ¨çš„åŸå­æ“ä½œï¼Œå°†æ•°å€¼deltaåŠ åˆ°é«˜32ä½çš„è®¡æ•°å™¨Vä¸Šï¼Œwæ˜¯waiterçš„å€¼ã€‚</p>
<p>Waitçš„å®ç°é€»è¾‘</p>
<pre><code>func (wg *WaitGroup) Wait() {
	if race.Enabled {
		race.Disable()
	}
	for {
		state := wg.state.Load()
		v := int32(state &gt;&gt; 32)
		w := uint32(state)
		if v == 0 {
			// Counter is 0, no need to wait.
			// å¦‚æœè®¡æ•°å™¨ä¸ºé›¶ï¼Œå°±æ— éœ€ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œåç»­çš„é€»è¾‘å³å¯
			if race.Enabled {
				race.Enable()
				race.Acquire(unsafe.Pointer(wg))
			}
			return
		}
		// Increment waiters count.
		// å¦åˆ™å°±æŠŠwaiterçš„æ•°é‡åŠ ä¸€ï¼Œåœ¨æ­¤æœŸé—´å¯èƒ½å­˜åœ¨å¹¶å‘è°ƒç”¨waitçš„æƒ…å†µï¼Œæ‰€ä»¥åœ¨æœ€å¤–å±‚ä½¿ç”¨äº†ä¸€ä¸ªforå¾ªç¯
		if wg.state.CompareAndSwap(state, state+1) {
			if race.Enabled &amp;&amp; w == 0 {
				// Wait must be synchronized with the first Add.
				// Need to model this is as a write to race with the read in Add.
				// As a consequence, can do the write only for the first waiter,
				// otherwise concurrent Waits will race with each other.
				race.Write(unsafe.Pointer(&amp;wg.sema))
			}
			runtime_Semacquire(&amp;wg.sema)// é˜»å¡ä¼‘çœ 
			if wg.state.Load() != 0 {
				panic(&quot;sync: WaitGroup is reused before previous Wait has returned&quot;)
			}
			if race.Enabled {
				race.Enable()
				race.Acquire(unsafe.Pointer(wg))
			}
			// è¢«å”¤é†’ï¼Œä¸åœ¨é˜»å¡ï¼Œè¿”å›
			return
		}
	}
}
</code></pre>
<p>Waitçš„ä¸»è¦é€»è¾‘ï¼šå°±æ˜¯ä¸æ–­çš„æ£€æŸ¥stateçš„å€¼ï¼Œå¦‚æœå…¶ä¸­è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œé‚£ä¹ˆè¯´æ˜ä»»åŠ¡å·²ç»å®Œæˆäº†ï¼Œå°±æ— éœ€å†ç­‰å¾…ï¼Œç›´æ¥è¿”å›å³å¯ï¼›å¦‚æœè®¡æ•°å™¨çš„å€¼å¤§äºé›¶ï¼Œé‚£ä¹ˆè¯´æ˜ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œé‚£ä¹ˆè°ƒç”¨è€…å°±å˜æˆäº†waiterï¼Œå°±éœ€è¦åŠ å…¥åˆ°waiterçš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”è¿›å…¥åˆ°é˜»å¡çš„çŠ¶æ€ã€‚</p>
<h1 id="4waitgroupçš„æ³¨æ„äº‹é¡¹">4.WaitGroupçš„æ³¨æ„äº‹é¡¹</h1>
<ol>
<li>WaitGroupçš„è®¡æ•°å€¼ä¸èƒ½ä¸ºè´Ÿæ•°ï¼š
<ol>
<li>åœ¨è°ƒç”¨Addæ–¹æ³•æ˜¯ï¼Œç»™äºˆå‚æ•°ä¸€ä¸ªè´Ÿå€¼ï¼Œç¨‹åºä¼šç›´æ¥panic</li>
<li>è°ƒç”¨Doneæ”¾çš„æ¬¡æ•°è¶…è¿‡åº”æœ‰çš„è®¡æ•°å™¨å€¼ï¼Œæˆ‘ä»¬çŸ¥é“Doneæ–¹æ³•çš„æœ¬èº«å°±æ˜¯Add(-1)</li>
</ol>
</li>
<li>Addæ–¹æ³•çš„è°ƒç”¨éœ€è¦å†Waitæ–¹æ³•ä¹‹å‰ï¼Œä¸”ä¸è¦åœ¨å­çš„goroutineçš„å†…è°ƒç”¨Addæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´Addå’ŒWaitçš„å…ˆåé¡ºåºæ–¹å¼å˜åŒ–ï¼Œä»–ä»¬ä¸¤ä¹‹é—´ï¼Œæ˜¯æœ‰ä¸¥æ ¼çš„å…ˆåé¡ºåºçš„</li>
<li>WaitGroupé‡ç”¨é—®é¢˜ï¼šWaitGroupæ˜¯å¯ä»¥é‡å¤ä½¿ç”¨çš„ï¼Œå½“è®¡æ•°å™¨å½’é›¶ï¼Œå¯ä»¥ç®—ä½œæ˜¯ä¸€ä¸ªæ–°çš„ï¼Œä½†æ˜¯å¦‚æœå…ˆå‰çš„ä¸€è½®è¿˜æ²¡ç»“æŸï¼Œåç»­æ–°çš„å°±è°ƒç”¨Addæ–¹æ³•ï¼Œä¼šå¯¼è‡´è®¡æ•°å™¨ä¸ºä¸ºè´Ÿå€¼ï¼Œç›´æ¥panicã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå°½é‡ä¸è¦é‡ç”¨WaitGroupï¼Œæ–°å»ºä¸€ä¸ªå¼€é”€ä¹Ÿå¾ˆå°</li>
</ol>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#1%E6%A6%82%E8%BF%B0">1.æ¦‚è¿°</a></li>
<li><a href="#2waitgroup%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2.WaitGroupçš„åŸºæœ¬ç”¨æ³•</a></li>
<li><a href="#3waitgroup%E7%9A%84%E5%AE%9E%E7%8E%B0">3.WaitGroupçš„å®ç°</a></li>
<li><a href="#4waitgroup%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">4.WaitGroupçš„æ³¨æ„äº‹é¡¹</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://ruofei-hu.github.io/post/zfCadduAi/">
              <h3 class="post-title">
                RWMutexçš„å®ç°åŸç†
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://ruofei-hu.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
