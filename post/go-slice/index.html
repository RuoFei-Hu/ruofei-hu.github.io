<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åˆ‡ç‰‡çš„åº•å±‚åŸç†å’Œä½¿ç”¨æ–¹æ³• | é£é£çš„Blog</title>
<link rel="shortcut icon" href="https://ruofei-hu.github.io/favicon.ico?v=1684694787815">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://ruofei-hu.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="åˆ‡ç‰‡çš„åº•å±‚åŸç†å’Œä½¿ç”¨æ–¹æ³• | é£é£çš„Blog - Atom Feed" href="https://ruofei-hu.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="åˆ‡ç‰‡çš„åº•å±‚åŸç†å’Œä½¿ç”¨æ–¹æ³•

ğŸ’¡ å½“å‰ä½¿ç”¨çš„Goç‰ˆæœ¬
go version go1.20.2 darwin/arm64

1.åˆ‡ç‰‡çš„ç»“æ„
Sliceæ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®ç»“æ„ã€‚

ä¸€ä¸ªåˆ‡ç‰‡åœ¨è¿è¡Œæ—¶ç”±æŒ‡é’ˆdata ã€é•¿åº¦len ã€å®¹é‡cap ä¸‰éƒ¨..." />
    <meta name="keywords" content="slice,go" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://ruofei-hu.github.io">
  <img class="avatar" src="https://ruofei-hu.github.io/images/avatar.png?v=1684694787815" alt="">
  </a>
  <h1 class="site-title">
    é£é£çš„Blog
  </h1>
  <p class="site-description">
    æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œå¯ä»¥è¿›æ­¥çŸ£ã€‚
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              åˆ‡ç‰‡çš„åº•å±‚åŸç†å’Œä½¿ç”¨æ–¹æ³•
            </h2>
            <div class="post-info">
              <span>
                2023-04-11
              </span>
              <span>
                11 min read
              </span>
              
                <a href="https://ruofei-hu.github.io/tag/z7Ms_79SE/" class="post-tag">
                  # slice
                </a>
              
                <a href="https://ruofei-hu.github.io/tag/ohj_y06Gy/" class="post-tag">
                  # go
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="åˆ‡ç‰‡çš„åº•å±‚åŸç†å’Œä½¿ç”¨æ–¹æ³•">åˆ‡ç‰‡çš„åº•å±‚åŸç†å’Œä½¿ç”¨æ–¹æ³•</h1>
<aside>
ğŸ’¡ å½“å‰ä½¿ç”¨çš„Goç‰ˆæœ¬
<p>go version go1.20.2 darwin/arm64</p>
</aside>
<h2 id="1åˆ‡ç‰‡çš„ç»“æ„">1.åˆ‡ç‰‡çš„ç»“æ„</h2>
<p>Sliceæ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®ç»“æ„ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://ruofei-hu.github.io/post-images/1681153822246.png" alt="" loading="lazy"></figure>
<p>ä¸€ä¸ªåˆ‡ç‰‡åœ¨è¿è¡Œæ—¶ç”±æŒ‡é’ˆ<code>data</code> ã€é•¿åº¦<code>len</code> ã€å®¹é‡<code>cap</code> ä¸‰éƒ¨åˆ†ç»„æˆã€‚</p>
<pre><code>type SliceHeader struct {
	Data uintptr // æŒ‡é’ˆæŒ‡å‘åˆ‡ç‰‡å…ƒç´ å¯¹åº”çš„åº•å±‚æ•°ç»„å…ƒç´ çš„åœ°å€
	Len  int     // é•¿åº¦å¯¹åº”åˆ‡ç‰‡ä¸­å…ƒç´ çš„æ•°é‡ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡å®¹é‡
	Cap  int     // å®¹é‡ä¸€èˆ¬æ˜¯ä»åˆ‡ç‰‡çš„å¼€å§‹ä½ç½®åˆ°åº•å±‚æ•°æ®ç»“æ„çš„ç»“å°¾ä½ç½®çš„é•¿åº¦
}
</code></pre>
<h2 id="2åˆ‡ç‰‡çš„åˆå§‹åŒ–">2.åˆ‡ç‰‡çš„åˆå§‹åŒ–</h2>
<p>åˆ‡ç‰‡æœ‰å¤šç§å£°æ˜æ–¹å¼ã€‚åœ¨åªå£°æ˜ä¸èµ‹åˆå§‹å€¼çš„æƒ…å†µä¸‹ï¼Œåˆ‡ç‰‡çš„å€¼ä¸ºé»˜è®¤çš„<code>nil</code>ã€‚åˆ‡ç‰‡åˆå§‹åŒ–éœ€è¦ä½¿ç”¨å†…ç½®çš„<code>make()</code> å‡½æ•°ã€‚</p>
<pre><code>	var slice1 []int                  // æ— åœ°å€ï¼Œåˆå§‹å€¼ä¸ºnil
	var slice2 = make([]int, 5)       // æœ‰åœ°å€ï¼Œæœ‰5ä¸ªé»˜è®¤ç±»å‹çš„é›¶å€¼ï¼ŒåŒæ—¶å®¹é‡ä¸º5
	var slice3 = make([]int, 0, 5)    // æœ‰åœ°å€ï¼Œæ— å…ƒç´ ï¼Œæœ‰ç©ºç™½çš„äº”ä¸ªæ ¼å­
	var slice4 = []int{0, 1, 2, 3, 4} // æœ‰åœ°å€ï¼Œæœ‰å…ƒç´ ï¼Œå¹¶æ˜¾ç¤ºçš„èµ‹å€¼
</code></pre>
<p>å½“åˆ‡ç‰‡çš„<code>len &lt; cap</code> çš„æ—¶å€™ï¼Œåˆ‡ç‰‡æ˜¯ä¸ç”¨æ‰©å®¹çš„ã€‚å¦‚æœåœ¨ä½¿ç”¨<code>make()</code> å‡½æ•°çš„æ—¶å€™ï¼Œä¸æ˜¾ç¤ºçš„æŒ‡å®šå®¹é‡å‚æ•°ï¼Œé»˜è®¤æ˜¯å’Œ<code>len</code> ä¿æŒä¸€è‡´ã€‚<code>slice4</code> ç§°ä¸ºåˆ‡ç‰‡çš„å­—é¢é‡ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µå¯¹åˆ‡ç‰‡è¿›è¡Œèµ‹å€¼ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ¨æ–­å‡ºåˆ‡ç‰‡çš„åˆå§‹åŒ–é•¿åº¦ï¼Œå¹¶è®©<code>len</code> å’Œ<code>cap</code> ä¿æŒä¸€è‡´ã€‚</p>
<p>å†…ç½®çš„<code>len()</code> å’Œ<code>cap()</code>   å‡½æ•°å¯ä»¥æµ‹é‡åˆ‡ç‰‡çš„é•¿åº¦å’Œå®¹é‡</p>
<h2 id="3åˆ‡ç‰‡çš„æˆªå–">3.åˆ‡ç‰‡çš„æˆªå–</h2>
<p>åˆ‡ç‰‡ä¸­çš„æ•°æ®åœ¨å†…å­˜ä¸­æ˜¯<strong>ä¸€ç‰‡è¿ç»­çš„åŒºåŸŸã€‚<strong>å¯ä»¥é€šè¿‡æ”¹å˜ä¸‹æ ‡çš„æ–¹å¼å¯¹åˆ‡ç‰‡è¿›è¡Œæˆªæ–­ï¼Œæˆªæ–­ä¹‹åçš„åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡éƒ½è®²ä¼šå‘ç”Ÿå˜åŒ–ã€‚åˆ‡ç‰‡æˆªå–çš„è§„åˆ™æ˜¯éµå¾ªæ•°å­¦ä¸­çš„</strong>å·¦é—­å³å¼€ï¼ˆå³å·¦åŒ…å«ï¼Œå³ä¸åŒ…å«ï¼‰ã€‚</strong></p>
<pre><code>	nums := []int{0, 1, 2, 3, 4, 5, 6, 7}
	nums1 := nums[:4]  // [0 1 2 3]
	nums2 := nums[4:]  // [4 5 6 7]
	nums3 := nums[2:4] // [2 3]
</code></pre>
<p>æ³¨æ„ğŸ“¢ âš ï¸ ï¼šåˆ‡ç‰‡åœ¨æˆªå–æ—¶çš„å¦ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ï¼Œè¢«æˆªå–åäº§ç”Ÿçš„å­åˆ‡ç‰‡å’Œæ¯åˆ‡ç‰‡å…±ç”¨ä¸€ä¸ªåº•å±‚æ•°ç»„ã€‚å¯¹å­åˆ‡ç‰‡è¿›è¡Œä¿®æ”¹ï¼Œä¼šå½±å“åˆ°æ¯åˆ‡ç‰‡ã€‚</p>
<pre><code>	foo := make([]int, 5) // å½“å‰ä¸º[0, 0, 0,  0,   0]
	foo[3] = 42           // å½“å‰ä¸º[0, 0 ,0, 42,   0]
	foo[4] = 500          // å½“å‰ä¸º[0, 0 ,0, 42, 500]
	bar := foo[1:4]       // å½“å‰ä¸º[0,  0 ,0, 42]
	bar[1] = 99           // å½“å‰ä¸º[0, 99 ,0, 42] ç›¸å½“äº foo[2] = 99
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://ruofei-hu.github.io/post-images/1681153855911.png" alt="" loading="lazy"></figure>
<h2 id="4åˆ‡ç‰‡çš„èµ‹å€¼å’Œå¼•ç”¨">4.åˆ‡ç‰‡çš„èµ‹å€¼å’Œå¼•ç”¨</h2>
<p>å¯¹åˆ‡ç‰‡Aå¤åˆ¶ç”Ÿæˆåˆ‡ç‰‡Bï¼Œåˆ‡ç‰‡Aå’Œåˆ‡ç‰‡Bæ˜¯å…±ç”¨ä¸€ä¸ªåº•å±‚æ•°ç»„ã€‚ä¿®æ”¹ä»»æ„ä¸€ä¸ªåˆ‡ç‰‡ï¼Œéƒ½ä¼šå½±å“å¦ä¸€ä¸ªåˆ‡ç‰‡ã€‚</p>
<p>åœ¨Goè¯­è¨€ä¸­ï¼Œå¤åˆ¶çš„æœ¬è´¨éƒ½æ˜¯å€¼å¤åˆ¶ï¼Œå¯¹äºåˆ‡ç‰‡çš„å¤åˆ¶ï¼Œå…¶å®æ˜¯å¯¹<code>SliceHeader</code> è¿™ä¸ªç»“æ„çš„å¤åˆ¶ï¼Œä½†æ˜¯å¤åˆ¶æ‰€è¡ç”Ÿå‡ºçš„å‰¯æœ¬å’Œä¹‹å‰çš„åˆ‡ç‰‡å…±ç”¨ä¸€ä¸ªåº•å±‚æ•°ç»„è€Œå·²ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://ruofei-hu.github.io/post-images/1681153865342.png" alt="" loading="lazy"></figure>
<h2 id="5makeåˆå§‹åŒ–">5.Makeåˆå§‹åŒ–</h2>
<p><code>ç¼–è¯‘æ—¶</code> å¯¹å­—é¢é‡çš„é‡è¦ä¼˜åŒ–æ˜¯åˆ¤æ–­å˜é‡åº”è¯¥è¢«åˆ†é…åˆ°æ ˆä¸­è¿˜æ˜¯é€ƒé€¸åˆ°å †åŒºã€‚</p>
<ol>
<li>å¦‚æœ<code>make</code> å‡½æ•°åˆå§‹åŒ–äº†ä¸€ä¸ªå¤ªå¤§çš„åˆ‡ç‰‡ï¼Œåˆ™è¯¥åˆ‡ç‰‡å°†ä¼šé€ƒé€¸åˆ°å †ä¸­</li>
<li>å¦‚æœåˆ†é…äº†ä¸€ä¸ªè¾ƒå°çš„åˆ‡ç‰‡ï¼Œåˆ™ç›´æ¥ä¼šåœ¨æ ˆä¸­åˆ†é…ã€‚</li>
</ol>
<p>è¡¡é‡åˆ‡ç‰‡å¤§å°çš„å€¼å­˜å‚¨åœ¨<code>/usr/local/go/src/cmd/compile/internal/ir.MaxImplicitStackVarSize</code> ä¸­ï¼Œé»˜è®¤æ˜¯64KBã€‚æ‰€ä»¥å½“ä½ åˆå§‹åŒ–<code>make([]int, 1023)</code> å’Œ<code>make([]int, 1024)</code> å®ç°çš„è¿‡ç¨‹æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<pre><code>package ir

var (
	// MaxStackVarSize is the maximum size variable which we will allocate on the stack.
	// This limit is for explicit variable declarations like &quot;var x T&quot; or &quot;x := ...&quot;.
	// Note: the flag smallframes can update this value.
	MaxStackVarSize = int64(10 * 1024 * 1024)

	// MaxImplicitStackVarSize is the maximum size of implicit variables that we will allocate on the stack.
	//   p := new(T)          allocating T on the stack
	//   p := &amp;T{}            allocating T on the stack
	//   s := make([]T, n)    allocating [n]T on the stack
	//   s := []byte(&quot;...&quot;)   allocating [n]byte on the stack
	// Note: the flag smallframes can update this value.
	MaxImplicitStackVarSize = int64(64 * 1024)

	// MaxSmallArraySize is the maximum size of an array which is considered small.
	// Small arrays will be initialized directly with a sequence of constant stores.
	// Large arrays will be initialized by copying from a static temp.
	// 256 bytes was chosen to minimize generated code + statictmp size.
	MaxSmallArraySize = int64(256)
)
</code></pre>
<p>å­—é¢é‡å†…å­˜é€ƒé€¸çš„æ ¸å¿ƒé€»è¾‘åœ¨<code>/usr/local/go/src/cmd/compile/internal/walk/expr.go</code> åœ¨<code>294</code> è¡Œå¤„æœ‰å…³äº<code>slice</code> çš„é€»è¾‘åˆ¤æ–­,ç„¶åä¼šè·³è½¬åˆ°<code>/usr/local/go/src/cmd/compile/internal/walk/builtin.go</code> ä¸­çš„<code>walkMakeSlice()</code> å‡½æ•°ä¸­ã€‚ å¦‚æœæ²¡æœ‰é€ƒé€¸ï¼Œé‚£ä¹ˆåˆ‡ç‰‡å°†ä¼šè¢«åˆ†é…åœ¨æ ˆä¸­ï¼Œå¦‚æœå‘ç”Ÿäº†é€ƒé€¸ï¼Œé‚£ä¹ˆ<code>runtime</code> å°†è°ƒç”¨<code>makeslice</code> æˆ–è€…<code>makeslice64</code> å‡½æ•°ï¼Œå¦‚æœåˆ‡ç‰‡çš„é•¿åº¦å°äº<code>int</code> ç±»å‹çš„æœ€å¤§å€¼ï¼Œå°†ä¼šè°ƒç”¨<code>makeslice</code> å‡½æ•°ï¼Œåä¹‹å°†ä¼šè°ƒç”¨<code>makeslice64</code> å‡½æ•°ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½ç½®åœ¨<code>/usr/local/go/src/runtime/slice.go</code> ä¸­</p>
<pre><code>func makeslice(et *_type, len, cap int) unsafe.Pointer {
	mem, overflow := math.MulUintptr(et.size, uintptr(cap))
	if overflow || mem &gt; maxAlloc || len &lt; 0 || len &gt; cap {
		// NOTE: Produce a 'len out of range' error instead of a
		// 'cap out of range' error when someone does make([]T, bignumber).
		// 'cap out of range' is true too, but since the cap is only being
		// supplied implicitly, saying len is clearer.
		// See golang.org/issue/4085.
		mem, overflow := math.MulUintptr(et.size, uintptr(len))
		if overflow || mem &gt; maxAlloc || len &lt; 0 {
			panicmakeslicelen()
		}
		panicmakeslicecap()
	}

	return mallocgc(mem, et, true)
}

func makeslice64(et *_type, len64, cap64 int64) unsafe.Pointer {
	len := int(len64)
	if int64(len) != len64 {
		panicmakeslicelen()
	}

	cap := int(cap64)
	if int64(cap) != cap64 {
		panicmakeslicecap()
	}

	return makeslice(et, len, cap)
}
</code></pre>
<p><code>makeslice</code> å‡½æ•°ä¼šå…ˆåˆ¤æ–­è¦ç”³è¯·çš„å†…å­˜æ˜¯å¦è¶…è¿‡ç³»ç»Ÿèƒ½åˆ†é…çš„æœ€å¤§å†…å­˜ï¼Œç„¶åå†åˆ¤æ–­é•¿åº¦æ˜¯éƒ½å¤§äºå®¹é‡,å¦‚æœæ£€æŸ¥æ²¡é—®é¢˜ï¼Œå°†è°ƒç”¨<code>mallocgc()</code> å‡½æ•°åœ¨å †ä¸­ç”³è¯·å†…å­˜ã€‚</p>
<h2 id="6åˆ‡ç‰‡çš„æ‰©å®¹åŸç†">6.åˆ‡ç‰‡çš„æ‰©å®¹åŸç†</h2>
<p>æˆ‘ä»¬ç›´æ¥å¼€é—¨è§å±±â›°ã€‚åˆ‡ç‰‡çš„æ‰©å®¹é€»è¾‘çš„ä»£ç ä½äº<code>/usr/local/go/src/runtime/slice.go</code></p>
<pre><code>func growslice(oldPtr unsafe.Pointer, newLen, oldCap, num int, et *_type) slice {
	oldLen := newLen - num
...

// go 1.17ä¹‹å‰çš„æ‰©å®¹æœºåˆ¶å’Œ 1.18ä¹‹åçš„ä¸åŒ
/////////////// è¿™ä¸€æ®µæ˜¯åˆ‡ç‰‡æ‰©å®¹çš„æ ¸å¿ƒé€»è¾‘

	newcap := oldCap
	doublecap := newcap + newcap
	if newLen &gt; doublecap {   // å¦‚æœæ–°ç”³è¯·çš„é•¿åº¦å¤§äºåŸæ¥æ—§å®¹é‡çš„äºŒå€
		newcap = newLen         // åˆ™æ–°å®¹é‡ç­‰äºæ–°ç”³è¯·çš„é•¿åº¦
	} else {
		const threshold = 256   // è®¾ç½®é˜ˆå€¼ä¸º256  1.17çš„ç‰ˆæœ¬é˜ˆå€¼æ˜¯1024
		if oldCap &lt; threshold { // å¦‚æœæ—§å®¹é‡å°äºé˜ˆå€¼256
			newcap = doublecap    // é‚£ä¹ˆæ–°å®¹é‡ç­‰äºæ—§å®¹é‡2å€
		} else {                // å¦‚æœæ—§å®¹é‡å¤§äºé˜ˆå€¼256
			// Check 0 &lt; newcap to detect overflow
			// and prevent an infinite loop.
			for 0 &lt; newcap &amp;&amp; newcap &lt; newLen { // ç¡®ä¿ 0&lt;**æ–°å®¹é‡**&lt;æ–°ç”³è¯·çš„é•¿åº¦ã€‚å¢é•¿é‡ä»ä»¥å‰æ¯æ¬¡ä¸ºå°å®¹é‡åˆ‡ç‰‡çš„2å€å¹³æ»‘çš„è¿‡æ¸¡ä¸ºå½“å‰å¤§å®¹é‡åˆ‡ç‰‡çš„1.25å€
				// Transition from growing 2x for small slices
				// to growing 1.25x for large slices. This formula
				// gives a smooth-ish transition between the two.
				newcap += (newcap + 3*threshold) / 4  // æ¯æ¬¡å¢é•¿é‡ä¸º ï¼ˆä¹‹å‰çš„æ–°å®¹é‡ + 3å€çš„é˜ˆå€¼ï¼‰çš„å››åˆ†ä¹‹ä¸€ ï¼Œç›´åˆ°æœ€ånewcap&gt;= newLen. 1.17ç‰ˆæœ¬ä¹‹å‰ newcap += newcap/4
			}
			// Set newcap to the requested cap when      //å½“newcapçš„è®¡ç®—æº¢å‡ºï¼Œé‚£ä¹ˆæœ€ç»ˆçš„newcapå°±æ˜¯æœ€ç»ˆæ‰€æ±‚çš„ã€‚
			// the newcap calculation overflowed.
			if newcap &lt;= 0 {
				newcap = newLen
			}
		}
	}
/////////////////////
	var overflow bool
	var lenmem, newlenmem, capmem uintptr
...
}
</code></pre>
<h3 id="go-118ç‰ˆæœ¬åˆ‡ç‰‡æ‰©å®¹">Go 1.18ç‰ˆæœ¬åˆ‡ç‰‡æ‰©å®¹</h3>
<p>Go1.18ä¸å†ä»¥1024ä¸ºä¸´ç•Œç‚¹ï¼Œè€Œæ˜¯è®¾å®šäº†ä¸€ä¸ªå€¼ä¸º256çš„<code>threshold</code>ï¼Œä»¥256ä¸ºä¸´ç•Œç‚¹ï¼›è¶…è¿‡256ï¼Œä¸å†æ˜¯æ¯æ¬¡æ‰©å®¹1/4ï¼Œè€Œæ˜¯æ¯æ¬¡å¢åŠ ï¼ˆæ—§å®¹é‡+3*256ï¼‰/4ï¼›</p>
<ul>
<li>å½“æ–°åˆ‡ç‰‡éœ€è¦çš„å®¹é‡capå¤§äºä¸¤å€æ‰©å®¹çš„å®¹é‡ï¼Œåˆ™ç›´æ¥æŒ‰ç…§æ–°åˆ‡ç‰‡éœ€è¦çš„å®¹é‡æ‰©å®¹ï¼›</li>
<li>å½“åŸ slice å®¹é‡ &lt; threshold çš„æ—¶å€™ï¼Œæ–° slice å®¹é‡å˜æˆåŸæ¥çš„ 2 å€ï¼›</li>
<li>å½“åŸ slice å®¹é‡ &gt; thresholdï¼Œè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡å®¹é‡å¢åŠ ï¼ˆæ—§å®¹é‡+3*thresholdï¼‰/4ã€‚</li>
</ul>
<p>å…¬å¼å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://ruofei-hu.github.io/post-images/1681153901208.png" alt="" loading="lazy"></figure>
<p>åœ¨1.18ä¸­ï¼Œä¼˜åŒ–äº†åˆ‡ç‰‡æ‰©å®¹çš„ç­–ç•¥ï¼Œè®©åº•å±‚æ•°ç»„å¤§å°çš„å¢é•¿æ›´åŠ å¹³æ»‘ï¼š é€šè¿‡å‡å°é˜ˆå€¼å¹¶å›ºå®šå¢åŠ ä¸€ä¸ªå¸¸æ•°ï¼Œä½¿å¾—ä¼˜åŒ–åçš„æ‰©å®¹çš„ç³»æ•°åœ¨é˜ˆå€¼å‰åä¸å†ä¼šå‡ºç°ä»2åˆ°1.25çš„çªå˜ï¼Œè¯¥commitä½œè€…ç»™å‡ºäº†å‡ ç§åŸå§‹å®¹é‡ä¸‹å¯¹åº”çš„â€œæ‰©å®¹ç³»æ•°â€ï¼š</p>
<table>
<thead>
<tr>
<th>oldcap</th>
<th>æ‰©å®¹ç³»æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>2.0</td>
</tr>
<tr>
<td>512</td>
<td>1.63</td>
</tr>
<tr>
<td>1024</td>
<td>1.44</td>
</tr>
<tr>
<td>2048</td>
<td>1.35</td>
</tr>
<tr>
<td>4096</td>
<td>1.30</td>
</tr>
</tbody>
</table>
<p>Go1.18çš„æ‰©å®¹ç­–ç•¥ä¸­ï¼Œéšç€å®¹é‡çš„å¢å¤§ï¼Œå…¶æ‰©å®¹ç³»æ•°æ˜¯è¶Šæ¥è¶Šå°çš„ï¼Œå¯ä»¥æ›´å¥½åœ°èŠ‚çœå†…å­˜ã€‚æˆ‘ä»¬å¯ä»¥è¯•ç€æ±‚ä¸€ä¸ªæé™ï¼Œå½“oldcapè¿œå¤§äº256çš„æ—¶å€™ï¼Œæ‰©å®¹ç³»æ•°å°†ä¼šå˜æˆ1.25ã€‚</p>
<p>Goçš„è®¾è®¡è€…ä¸æ–­ä¼˜åŒ–åˆ‡ç‰‡æ‰©å®¹çš„æœºåˆ¶ï¼Œå…¶ç›®çš„åªæœ‰ä¸€ä¸ªï¼šå°±æ˜¯æ§åˆ¶è®©å°çš„åˆ‡ç‰‡å®¹é‡å¢é•¿é€Ÿåº¦å¿«ä¸€ç‚¹ï¼Œå‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°ï¼Œè€Œè®©å¤§åˆ‡ç‰‡å®¹é‡å¢é•¿ç‡å°ä¸€ç‚¹ï¼Œæ›´å¥½åœ°èŠ‚çœå†…å­˜ã€‚</p>
<ul>
<li>å¦‚æœåªé€‰æ‹©ç¿»å€çš„æ‰©å®¹ç­–ç•¥ï¼Œé‚£ä¹ˆå¯¹äºè¾ƒå¤§çš„åˆ‡ç‰‡æ¥è¯´ï¼Œä¹‹å‰çš„æ‰©å®¹ç­–ç•¥æµªè´¹å†…å­˜ï¼Œç°æœ‰çš„æ–¹æ³•å¯ä»¥æ›´å¥½çš„èŠ‚çœå†…å­˜ã€‚</li>
<li>å¦‚æœåªé€‰æ‹©æ¯æ¬¡ç³»æ•°ä¸º1.25çš„æ‰©å®¹ç­–ç•¥ï¼Œé‚£ä¹ˆå¯¹äºè¾ƒå°çš„åˆ‡ç‰‡æ¥è¯´æ‰©å®¹ä¼šå¾ˆä½æ•ˆï¼Œç°æœ‰çš„æ–¹æ³•å¯ä»¥é«˜æ•ˆçš„æ‰©å®¹</li>
<li>ä¹‹æ‰€ä»¥é€‰æ‹©ä¸€ä¸ªå°äº2çš„ç³»æ•°ï¼Œåœ¨æ‰©å®¹æ—¶è¢«é‡Šæ”¾çš„å†…å­˜å—ä¼šåœ¨ä¸‹ä¸€æ¬¡æ‰©å®¹æ—¶æ›´å®¹æ˜“è¢«é‡æ–°åˆ©ç”¨</li>
</ul>
<p>Append()å‡½æ•°å’Œåˆ‡ç‰‡çš„æ‰©å®¹å¯†åˆ‡ç›¸å…³ï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡è¿›è¡Œappendæ“ä½œæ—¶ï¼Œåˆ‡ç‰‡éƒ½ä¼šæ‰©å®¹ï¼Œåªæœ‰åœ¨è¿½åŠ çš„å…ƒç´ ä¸ªæ•° &gt; (cap-len)çš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ‰©å®¹ã€‚å¹¶ä¸”appendå‡½æ•°å¯ä»¥å°†æœªåˆå§‹åŒ–çš„åˆ‡ç‰‡åˆå§‹åŒ–ã€‚</p>
<h2 id="7åˆ‡ç‰‡çš„å¤åˆ¶">7.åˆ‡ç‰‡çš„å¤åˆ¶</h2>
<p>å¤åˆ¶çš„åˆ‡ç‰‡ä¸ä¼šæ”¹å˜æŒ‡å‘åº•å±‚çš„æ•°ç»„ï¼Œå¦‚æœè¿›è¡Œå€¼ä¿®æ”¹ï¼Œä¼šå½±å“å½¼æ­¤ã€‚å¦‚æœåªæ˜¯å•çº¯çš„å¤åˆ¶åˆ‡ç‰‡ï¼Œä¸å…±ç”¨åº•å±‚æ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨<code>copy</code> å‡½æ•°ï¼Œ<code>copy</code> å‡½æ•°åœ¨<code>runtime</code> ä¸»è¦è°ƒç”¨<code>memmove</code> å‡½æ•°ï¼Œå®ç°å†…å­˜çš„å¤åˆ¶ã€‚</p>
<h2 id="8æ€»ç»“">8.æ€»ç»“</h2>
<ol>
<li>Goè¯­è¨€çš„ä¼ å‚æ–¹å¼æ˜¯å€¼æ‹·è´ï¼Œå¯¹äºsliceä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡å¤åˆ¶çš„æ˜¯<code>SliceHeader</code> çš„ç»“æ„ã€‚ç”±äºåº•å±‚æ•°æ®ç»“æ„çš„å®ç°ï¼Œå¯¼è‡´ï¼Œå¤åˆ¶çš„ååˆ‡ç‰‡å’Œä¹‹å‰çš„åˆ‡ç‰‡å…±ç”¨åŒä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œä¼šå¯¼è‡´å½¼æ­¤ä¿®æ”¹å…ƒç´ å€¼çš„æ—¶å€™ä¼šäº’ç›¸å½±å“ï¼Œå¯ä»¥é‡‡ç”¨<code>copy</code> å‡½æ•°é¿å…ï¼›</li>
<li>å½“<code>make</code> å‡½æ•°åˆå§‹åŒ–ä¸€ä¸ªå¤§äº64KBçš„åˆ‡ç‰‡æ—¶å€™ï¼Œè¿™ä¸ªåˆ‡ç‰‡å°†ä¼šé€ƒé€¸åˆ°å †åŒºï¼Œå°äº64KBçš„åˆ‡ç‰‡å°†åœ¨æ ˆä¸Šç›´æ¥åˆå§‹åŒ–ï¼›</li>
<li>åˆ‡ç‰‡çš„æ‰©å®¹ç­–ç•¥åœ¨<code>1.17</code> å’Œ<code>1.18</code> é—´å‘ç”Ÿäº†å˜åŒ–ï¼Œ1.18ä¹‹åæ‰©å®¹ä¼šæ›´åŠ å¹³æ»‘ï¼Œä¸åˆ°å‡ºç°æ‰©å®¹ç³»æ•°ä» <code>2 -&gt; 1.25</code>  çš„æƒ…å†µï¼Œè¿‡æ¸¡çš„ä¼šæ›´åŠ åˆç†ã€‚1.17ä¹‹å‰çš„é˜ˆå€¼ä¸º1024ï¼Œ å½“å¤§äº1024æ—¶æ¯æ¬¡å¢åŠ æ—§å®¹é‡çš„1/4ï¼›1.18ä¹‹åçš„é˜ˆå€¼ä¸º256ï¼Œå¤§äº256é˜ˆå€¼æ—¶ï¼Œæ¯æ¬¡å¢åŠ  <code>(æ—§å®¹é‡ + 256 * 3)/4</code></li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™:</h2>
<ul>
<li><a href="https://juejin.cn/post/7101928883280150558">Go 1.18 å…¨æ–°çš„åˆ‡ç‰‡æ‰©å®¹æœºåˆ¶ - æ˜é‡‘</a></li>
<li>go version go1.20.2 darwin/arm64 æºç </li>
</ul>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E5%88%87%E7%89%87%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%92%8C%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">åˆ‡ç‰‡çš„åº•å±‚åŸç†å’Œä½¿ç”¨æ–¹æ³•</a>
<ul>
<li><a href="#1%E5%88%87%E7%89%87%E7%9A%84%E7%BB%93%E6%9E%84">1.åˆ‡ç‰‡çš„ç»“æ„</a></li>
<li><a href="#2%E5%88%87%E7%89%87%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96">2.åˆ‡ç‰‡çš„åˆå§‹åŒ–</a></li>
<li><a href="#3%E5%88%87%E7%89%87%E7%9A%84%E6%88%AA%E5%8F%96">3.åˆ‡ç‰‡çš„æˆªå–</a></li>
<li><a href="#4%E5%88%87%E7%89%87%E7%9A%84%E8%B5%8B%E5%80%BC%E5%92%8C%E5%BC%95%E7%94%A8">4.åˆ‡ç‰‡çš„èµ‹å€¼å’Œå¼•ç”¨</a></li>
<li><a href="#5make%E5%88%9D%E5%A7%8B%E5%8C%96">5.Makeåˆå§‹åŒ–</a></li>
<li><a href="#6%E5%88%87%E7%89%87%E7%9A%84%E6%89%A9%E5%AE%B9%E5%8E%9F%E7%90%86">6.åˆ‡ç‰‡çš„æ‰©å®¹åŸç†</a>
<ul>
<li><a href="#go-118%E7%89%88%E6%9C%AC%E5%88%87%E7%89%87%E6%89%A9%E5%AE%B9">Go 1.18ç‰ˆæœ¬åˆ‡ç‰‡æ‰©å®¹</a></li>
</ul>
</li>
<li><a href="#7%E5%88%87%E7%89%87%E7%9A%84%E5%A4%8D%E5%88%B6">7.åˆ‡ç‰‡çš„å¤åˆ¶</a></li>
<li><a href="#8%E6%80%BB%E7%BB%93">8.æ€»ç»“</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™:</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://ruofei-hu.github.io/post/go-sync/">
              <h3 class="post-title">
                GoåŸºæœ¬åŒæ­¥åŸè¯­
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://ruofei-hu.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
